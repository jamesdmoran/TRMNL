name: TRMNL Webhook

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:
    inputs:
      reason:
        description: Optional reason for the manual trigger
        required: false
        type: string

permissions:
  contents: read

jobs:
  notify-trmnl:
    runs-on: ubuntu-latest

    steps:
      - name: Build webhook payload
        id: payload
        env:
          MANUAL_REASON: ${{ github.event.inputs.reason }}
        run: |
          payload="$(jq -n \
            --arg repository "${GITHUB_REPOSITORY}" \
            --arg branch "${GITHUB_REF_NAME}" \
            --arg ref "${GITHUB_REF}" \
            --arg sha "${GITHUB_SHA}" \
            --arg actor "${GITHUB_ACTOR}" \
            --arg event "${GITHUB_EVENT_NAME}" \
            --arg run_id "${GITHUB_RUN_ID}" \
            --arg run_attempt "${GITHUB_RUN_ATTEMPT}" \
            --arg run_number "${GITHUB_RUN_NUMBER}" \
            --arg workflow "${GITHUB_WORKFLOW}" \
            --arg server_url "${GITHUB_SERVER_URL}" \
            --arg reason "${MANUAL_REASON}" \
            '{
              source: "github-actions",
              repository: $repository,
              branch: $branch,
              ref: $ref,
              sha: $sha,
              actor: $actor,
              event: $event,
              workflow: $workflow,
              run: {
                id: $run_id,
                attempt: $run_attempt,
                number: $run_number,
                url: ($server_url + "/" + $repository + "/actions/runs/" + $run_id)
              },
              reason: (if ($reason | length) > 0 then $reason else null end),
              timestamp_utc: (now | strftime("%Y-%m-%dT%H:%M:%SZ"))
            }')"

          echo "json=${payload}" >> "${GITHUB_OUTPUT}"

      - name: Post to TRMNL webhook
        env:
          TRMNL_WEBHOOK_URL: ${{ secrets.TRMNL_WEBHOOK_URL }}
          TRMNL_WEBHOOK_BEARER: ${{ secrets.TRMNL_WEBHOOK_BEARER }}
          PAYLOAD: ${{ steps.payload.outputs.json }}
        run: |
          if [ -z "${TRMNL_WEBHOOK_URL}" ]; then
            echo "Missing secret: TRMNL_WEBHOOK_URL" >&2
            exit 1
          fi

          auth_headers=()
          if [ -n "${TRMNL_WEBHOOK_BEARER}" ]; then
            auth_headers=(-H "Authorization: Bearer ${TRMNL_WEBHOOK_BEARER}")
          fi

          curl --fail --show-error --silent \
            --retry 3 \
            --retry-delay 2 \
            -X POST \
            -H "Content-Type: application/json" \
            "${auth_headers[@]}" \
            --data "${PAYLOAD}" \
            "${TRMNL_WEBHOOK_URL}"
